#!/usr/bin/python3

# Copyright 2020 Dara Poon and the University of British Columbia

from itertools import groupby
import fileinput
import sys
import mailrules.procmailrc as procmailrc
import mailrules.proc_to_sieve as proc_to_sieve

def convert_procmailrc(filename, lines):
    parser = procmailrc.Parser(filename)
    return proc_to_sieve.Procmailrc(
        list(parser.parse_rules(parser.numbered_line_iter(lines))),
        proc_to_sieve.ProcmailContext(env={
            'LOGNAME': '$LOGNAME',
            'HOME': '$HOME',
            'MAILDIR': '$HOME/Maildir',
            'DEFAULT': '$HOME/Maildir/',
            'ORGMAIL': '$HOME/Maildir/',
        })
    )

def main():
    it = fileinput.input()
    for filename, lines in groupby(it, lambda line: it.filename()):
        print('\n{0} {1} {2}'.format('#' * 10, filename, '=' * 10))
        print(convert_procmailrc(filename, lines))
    sys.exit(1 if proc_to_sieve.FIXME.instances else 0)

if __name__ == '__main__':
    main()
